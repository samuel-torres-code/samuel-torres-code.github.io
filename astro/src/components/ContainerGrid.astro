---
let containers: Array<{ image: string; status: string; created: number; name?: string }> = [];
import '../styles/index.css';

try {
  const response = await fetch("https://api.issabella.club/containers");
  
  if (!response.ok) {
    throw new Error(`Failed to fetch containers: ${response.status} ${response.statusText}`);
  }
  
  const data = await response.json();
  
  // Ensure containers is always an array
  if (Array.isArray(data)) {
    containers = data;
  } else if (data.containers && Array.isArray(data.containers)) {
    containers = data.containers;
  } else if (data.data && Array.isArray(data.data)) {
    containers = data.data;
  } else {
    console.warn('Unexpected data structure from containers API:', data);
    containers = [];
  }
} catch (error) {
  console.error('Error fetching containers:', error);
  containers = [];
}


const formatDate = (timestamp: number): string => {
  if (!timestamp) return 'Unknown';
  
  // Handle both Unix timestamp (seconds) and milliseconds
  // If timestamp is less than a reasonable date in seconds (year 2000), assume it's in seconds
  const date = timestamp < 946684800000 
    ? new Date(timestamp * 1000) 
    : new Date(timestamp);
  
  // Check if date is valid
  if (isNaN(date.getTime())) return 'Invalid date';
  
  return date.toISOString();
  
};

const formatStatus = (status: string): string => {
    return status.split(" ")[0]
}

const formatName = (name: string | undefined): string => {
    if (name === undefined) {
        return 'Unnamed Container'
    }
    return name?.split("/")[1]
}

const formatImage = (image: string): string => {
    if (image.includes(":")) {
        image = image.split(":")[0]
    }

    if (!image) {
        return "N/A"
    }

    return image
}

---

<section class="container-table-wrapper">
    {containers.length === 0 ? (
        <p>No containers available at the moment.</p>
    ) : (
        <table class="container-table outline">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Name</th>
                    <th>Image</th>
                    
                    <th>Date Created</th>
                </tr>
            </thead>
            <tbody>
                {containers.map((container: { image: string; status: string; created: number; name?: string }) => (
                    <tr>
                        <td>{formatStatus(container.status)}</td>
                        <td>{formatName(container.name)}</td>
                        <td>{formatImage(container.image)}</td>
                        <td>{formatDate(container.created)}</td>
                    </tr>
                ))}
            </tbody>
        </table>
    )}
</section>

<style>
    .container-table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .container-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .container-table th {
        text-align: left;
    }

    .container-table td {
        overflow: hidden;
        white-space: nowrap; /* Don't forget this one */
        text-overflow: ellipsis;
        max-width: 10rem;
    }

    .container-table tbody tr:last-child td {
        border-bottom: none;
    }

    @media (max-width: 768px) {
        .container-table {
            font-size: 0.85rem;
        }

        .container-table th,
        .container-table td {
        }
    }
</style>

